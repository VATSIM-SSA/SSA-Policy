name: Quarterly Release Branch + Last-Quarter Release

on:
  # 00:05 UTC on Jan 1, Apr 1, Jul 1, Oct 1
  schedule:
    - cron: "5 0 1 1,4,7,10 *"
  workflow_dispatch:
    inputs:
      year:
        description: "Override year (e.g., 2025). Leave blank to auto-detect UTC today."
        required: false
      quarter:
        description: "Override quarter number (1â€“4). Leave blank to auto-detect UTC today."
        required: false
      dry_run:
        description: "true = print actions only"
        required: false
        default: "false"

permissions:
  contents: write # needed to push branches/tags
  pull-requests: write

jobs:
  rollover:
    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: main
      DRY_RUN: ${{ inputs.dry_run || 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute current & previous quarter (UTC)
        id: q
        shell: bash
        run: |
          Y="${{ inputs.year }}"
          Q="${{ inputs.quarter }}"

          if [ -z "$Y" ] || [ -z "$Q" ]; then
            Y=$(date -u +%Y)
            M=$(date -u +%m)
            Q=$(( ( (10#$M - 1) / 3 ) + 1 ))
          fi

          # Validate
          [[ "$Y" =~ ^[0-9]{4}$ ]] || { echo "Invalid year: $Y"; exit 1; }
          [[ "$Q" =~ ^[1-4]$ ]] || { echo "Invalid quarter: $Q"; exit 1; }

          # Previous quarter (and possibly previous year)
          if [ "$Q" -eq 1 ]; then
            PREV_Y=$((Y - 1)); PREV_Q=4
          else
            PREV_Y=$Y; PREV_Q=$((Q - 1))
          fi

          CURR_BRANCH="release/${Y}q${Q}"            # ongoing branch to create
          PREV_BRANCH="release/${PREV_Y}q${PREV_Q}"  # last quarter's branch
          PREV_TAG="v${PREV_Y}.Q${PREV_Q}"           # release tag (capital Q)

          echo "curr_branch=${CURR_BRANCH}"   >> $GITHUB_OUTPUT
          echo "prev_branch=${PREV_BRANCH}"   >> $GITHUB_OUTPUT
          echo "prev_tag=${PREV_TAG}"         >> $GITHUB_OUTPUT

          echo "Current : $CURR_BRANCH"
          echo "Previous: $PREV_BRANCH (tag -> $PREV_TAG)"

      - name: Ensure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create the new quarterly branch if missing
        shell: bash
        run: |
          BR="${{ steps.q.outputs.curr_branch }}"

          # Up-to-date base
          git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}"

          # Remote existence check
          if git ls-remote --exit-code --heads origin "refs/heads/${BR}" >/dev/null 2>&1; then
            echo "Branch ${BR} already exists on origin. Nothing to do."
            exit 0
          fi

          if [ "$DRY_RUN" = "true" ]; then
            echo "[dry-run] Would create ${BR} from origin/${BASE_BRANCH}"
          else
            git branch "${BR}" "origin/${BASE_BRANCH}"
            git push origin "${BR}:${BR}"
            echo "Created ${BR}"
          fi

      - name: Tag last quarter's tip (if branch exists & tag absent)
        id: tagprev
        shell: bash
        run: |
          PREV_BR="${{ steps.q.outputs.prev_branch }}"
          PREV_TAG="${{ steps.q.outputs.prev_tag }}"

          # Check branch exists remotely
          if ! git ls-remote --exit-code --heads origin "refs/heads/${PREV_BR}" >/dev/null 2>&1; then
            echo "Previous branch ${PREV_BR} not found on origin. Skipping tag."
            echo "tagged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Already tagged?
          if git rev-parse -q --verify "refs/tags/${PREV_TAG}" >/dev/null; then
            echo "Tag ${PREV_TAG} exists locally."
          else
            git fetch --tags origin || true
          fi
          if git ls-remote --exit-code --tags origin "refs/tags/${PREV_TAG}" >/dev/null 2>&1; then
            echo "Tag ${PREV_TAG} already exists on origin. Skipping create."
            echo "tagged=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create tag from the remote branch tip
          COMMIT=$(git ls-remote origin "refs/heads/${PREV_BR}" | awk '{print $1}')
          if [ -z "$COMMIT" ]; then
            echo "Could not resolve commit for ${PREV_BR}"; exit 1
          fi

          if [ "$DRY_RUN" = "true" ]; then
            echo "[dry-run] Would create annotated tag ${PREV_TAG} at ${COMMIT}"
          else
            git tag -a "${PREV_TAG}" -m "Quarterly release ${PREV_TAG}" "${COMMIT}"
            git push origin "refs/tags/${PREV_TAG}"
            echo "Created tag ${PREV_TAG} at ${COMMIT}"
          fi

          echo "tagged=true" >> $GITHUB_OUTPUT

      - name: Create GitHub Release for last quarter (with notes)
        if: steps.tagprev.outputs.tagged == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          PREV_TAG="${{ steps.q.outputs.prev_tag }}"
          TITLE="Quarterly Release ${PREV_TAG}"
          if [ "$DRY_RUN" = "true" ]; then
            echo "[dry-run] Would create GitHub Release ${TITLE}"
          else
            gh release create "${PREV_TAG}" \
              --title "${TITLE}" \
              --generate-notes
          fi
